# POTAL AI Behavioral Guidelines & Absolute Rules (.cursorrules)
# 마지막 업데이트: 2026-02-22

## 1. Business Philosophy (The "Why")
- **Target Audience:** US Residents (미국 현지인). 절대 한국인의 직구 관점으로 배송/서비스를 해석하지 마라.
- **Transparency:** API가 주는 정보(도착일, 배송비)는 100% 투명하게 공개한다.
- **First Impression:** 사용자에게 두 번째 기회는 없다. 첫 16개 상품 리스트와 UI에서 압도적인 편의성을 제공해야 한다.
- **Clean UI:** 반복되는 툴팁(Tooltip)은 시각적 공해다. 개별 툴팁을 제거하고 상단 'Unified Shipping Guide'를 사용한다.

## 2. Anti-Amnesia (Do Not Forget / Zombie Ideas)
- **Mall Classification:** eBay와 iHerb는 미국인에게 **Domestic(내수)** 쇼핑몰이다. 절대 Global 탭에 넣지 마라.
- **Show More Button:** 'Show More' 버튼은 필수다. 삭제 제안 금지 (무한 스크롤 IntersectionObserver 구현됨).
- **Mobile Layout:** 모바일 검색 결과는 **2열(grid-cols-2)** 그리드. 위시리스트도 동일한 2열 그리드.
- **Price Tag:** 배송비가 'Free'인 경우, 가격 옆에 `+ Shipping` 텍스트를 절대 중복 표기하지 마라.
- **Data Driven:** 필터 생성 시 LLM 추론을 사용하지 마라. API 응답 데이터 기반으로 생성한다.
- **Image Container:** 상품 카드 이미지는 반드시 `paddingBottom: '125%' + height: 0` 인라인 스타일 방식으로 고정. `aspectRatio` CSS 사용 금지. img 태그는 `position: absolute; top: 0; left: 0; width: 100%; height: 100%; objectFit: contain; padding: 6px`.
- **모바일 카드 텍스트/아이콘 표준 크기 (2026-02-22 적용):** 셀러뱃지 9px, 별점/리뷰 10px/9px, 공유/하트 아이콘 w-4 h-4 (16px) + 터치영역 36x36px, 상품명 12px (3줄 clamp, minHeight 4.2em), 멤버십뱃지 9px, 배송/날짜 9px, Est.Tax/Product 10px, Total라벨 9px, Total가격 18px. 검색카드와 위시리스트 카드 동일.
- **POTAL Filter 브랜딩:** "AI Smart Suggestion" 이름은 사용하지 않음. 사용자에게 보이는 모든 곳에서 **"POTAL Filter"** 사용. 내부 코드 식별자(AiSmartSuggestionBox 등)는 유지.
- **Inline Styles 우선:** Tailwind CSS 캐싱 이슈로 시각적 핵심 요소는 반드시 `style={{}}` 인라인 스타일 사용. 특히 배경색, 이미지 컨테이너, 뱃지 색상 등.
- **No browser confirm():** 모바일에서 `confirm()`, `alert()`, `prompt()` 사용 금지. 바텀시트 또는 커스텀 모달 UI 사용 (위시리스트 Clear에서 이미 구현됨).
- **Dark Theme 통일:** 모든 페이지 배경 `#02122c` (네이비). 새 페이지/컴포넌트 만들 때도 네이비 다크 테마 유지.
- **카드 스타일 통일:** 검색결과 MobileCompactCard와 위시리스트 WishlistMobileCard는 반드시 동일한 구조/스타일 유지. 하나 수정하면 다른 것도 동일하게 수정.
- **Product 필드 호환:** product 객체의 필드명이 컴포넌트마다 다를 수 있음 (title/name, thumb/image, seller/site). 항상 `product.title || product.name || 'Untitled'` 식으로 폴백 처리.
- **wishProduct 객체:** 위시리스트에 저장할 때 `is_prime`, `badges`, `arrives`, `shipping`, `appliedMembership`, `membershipBadge`, `type` 필드를 반드시 포함해야 뱃지가 위시리스트에서도 표시됨.

## 3. Coding Standards
- **Grid System:** PC(Large Screen)에서는 **3열(grid-cols-3)**을 최대로 유지하여 상품 이미지 시인성을 확보한다.
- **Ranking Logic:** Domestic/Global 탭 내부에서는 사이트별 1등 상품을 **교차(Zipper)** 배치하여 공정성을 보장한다. `interleaveBySite()` 함수가 search/page.tsx에 있음.
- **z-index 계층 (절대 변경하지 마라):**
  - StickyHeader: z-[2000]
  - BottomNav (글라스모피즘 pill): z-[9999]
  - 풀스크린 시트 (AiSmartSuggestionBox 등): z-[10001]
  - 바텀시트 확인 모달 (Clear 등): z-[10002]
- **모바일/PC 분리:** `md:hidden` / `hidden md:block` 패턴 사용. PC 레이아웃에 영향 주지 않도록 주의.
- **Next.js 16:** `params`가 Promise로 바뀜. 동적 라우트에서 `use(params)` 또는 `await params` 사용 필수. 기존 `params.slug` 직접 접근은 undefined 발생.
- **이벤트 핸들링:** 카드 내부 버튼 (공유, 하트 등)은 반드시 `e.preventDefault()` + `e.stopPropagation()` 처리. 안하면 카드 클릭 (상품 링크 열기)이 같이 발생함.
- **색상 매핑:** 리테일러별 플랫폼 색상은 `MOBILE_PLATFORM_COLORS` / `PLATFORM_COLORS` 딕셔너리에 정의됨. Amazon=#FF9900, Walmart=#0071ce, Target=#CC0000, eBay=#E53238, AliExpress=#E43225 등.
- **twToHex() 헬퍼:** Tailwind 클래스 문자열에서 hex 색상을 추출하는 함수. `bg-[#FF9900]` → `#FF9900`. ResultsGrid.tsx와 wishlist/page.tsx 양쪽에 동일하게 존재.

## 4. 검색 결과 카드 구조 (MobileCompactCard)
카드 전체 구조 (위→아래):
```
┌─────────────────────────┐
│ [셀러 뱃지]    [★ 리뷰] │  ← 상단 바
├─────────────────────────┤
│                    [↗][♡]│  ← 이미지 우측상단 공유+하트
│      [상품 이미지]       │  ← paddingBottom: 125%, height: 0
│                         │
├─────────────────────────┤
│ 상품명 (2줄 clamp)      │  ← 타이틀
├───────── ── ────────────┤  ← 구분선 (separator)
│ 뱃지+배송+🚀배송일      │  ← 가격 1줄
│ Est.Tax $X.XX           │  ← 가격 2줄
│ $XX.XX (상품가)  Total  │  ← 가격 3줄
│                 $XX.XX  │  ← Total 가격 (큰 글씨)
└─────────────────────────┘
```

- **이미지 영역:** `paddingBottom: '125%'` + `height: 0` + `position: absolute` img
- **이미지 우측상단:** 공유 아이콘(Skyscanner 3-node 네트워크) + 하트 아이콘 (반투명 원형 배경 `rgba(0,0,0,0.35)`)
- **가격 영역 3줄 구조:**
  - 1줄: 멤버십 뱃지(있으면) + 배송비(Free/+$X) + 🚀 + 배송일(1-2 Days / 7-15 Days)
  - 2줄: Est.Tax / Est.Duty (isGlobal 여부에 따라)
  - 3줄: 좌측=상품가격, 우측=Total 라벨+큰 가격
- **뱃지 4단계 우선순위:**
  1. `membershipBadge` (ScoringEngine 제공) — twToHex로 색상 변환
  2. `shippingProg` (retailerConfig의 matchShippingProgram 매칭)
  3. `is_prime` → 'Prime' 뱃지 (#232F3E bg, #00A8E1 text)
  4. `appliedMembership` → 이름을 Title Case로 변환
- **위시리스트 카드(WishlistMobileCard)도 동일 구조** 유지. 단, 하트 대신 빨간 삭제 버튼.

## 5. 주요 파일 매핑 (⚠️ 매우 중요)

### 프론트엔드 — 실제 사용 파일
| 파일 | 역할 | 비고 |
|------|------|------|
| `components/search/ResultsGrid.tsx` | 검색 결과 그리드 + MobileCompactCard | ⚠️ 실제 사용 파일. ~1200줄. |
| `app/components/ProductCard.tsx` | PC 상품 카드 | 데스크톱/모바일 양쪽 카드 포함 |
| `app/wishlist/page.tsx` | 위시리스트 페이지 | WishlistMobileCard + PC ProductCard + Clear 바텀시트 |
| `app/search/page.tsx` | 검색 결과 페이지 | 상태 관리 (query, sort, market, providerStatus 등) |
| `app/page.tsx` | 메인 홈페이지 | 모바일/PC 분리 레이아웃 |
| `app/profile/page.tsx` | 프로필 페이지 | 2x2 그리드 + 슬라이드 서브페이지 + Zipcode |
| `components/search/StickyHeader.tsx` | 검색 스티키 헤더 | market 탭, 검색바, 정렬 |
| `components/layout/MobileBottomNav.tsx` | 모바일 바텀 네비 | 글라스모피즘 pill bar (3탭) |
| `components/icons.tsx` | 아이콘 컴포넌트 | Share, Heart, HeartFilled, Shield, ChevronLeft, Plus 등 |
| `app/context/WishlistContext.tsx` | 위시리스트 Context | localStorage 'potal_wishlist' 키 사용 |

### 프론트엔드 — 안 쓰는 파일 (수정하지 마라!)
| 파일 | 비고 |
|------|------|
| `app/components/search/ResultsGrid.tsx` | ❌ 백업 파일. 실제 사용 안 함 |
| `app/components/search/StickyHeader.tsx` | ❌ 백업 파일 |
| `app/components/search/AiSmartSuggestionBox.tsx` | ❌ 백업 파일 |

### 백엔드
| 파일 | 역할 |
|------|------|
| `app/lib/agent/Coordinator.ts` | 검색 파이프라인 오케스트레이션 + providerStatus 추적 |
| `app/lib/agent/QueryAgent.ts` | 검색어 분석 + 플랫폼별 쿼리 생성 |
| `app/lib/search/types.ts` | Product, SearchResult 등 타입 정의 |
| `app/lib/retailerConfig.ts` | 리테일러 설정 + 어필리에이트 + 멤버십 뱃지 매칭 |
| `app/lib/search/CostEngine.ts` | Total Landed Cost 계산 |
| `app/lib/search/ScoringEngine.ts` | Best/Cheapest/Fastest 점수 |
| `app/api/search/route.ts` | 검색 API 엔드포인트 |

## 6. 유저(Euntae) 디자인 성향 & 피드백 패턴
- **스카이스캐너(Skyscanner) 모바일 UX**를 주요 레퍼런스로 사용
- 수정 전이 나을 때 바로 "수정전이 더 괜찮네" → 즉시 리버트
- 이모지 아이콘 배경 박스 싫어함 → 이모지만 사용
- 오렌지 포인트 좋아하지만 흐리면 안됨 → 진하게 (`opacity/60` 제거, `font-bold`)
- 콜라보레이션 방식: 유저가 방향 제시 → 구현 → 유저 피드백 → 조정
- 한국어로 소통하되 코드/기술 용어는 영어 그대로 사용
- 코딩 초보자이므로 기술적 설명은 간결하게, 작업은 직접 해줘야 함

## 7. 배포
- **Vercel Pro** → `potal.app` 도메인
- `main` 브랜치에 push하면 자동 배포
- .env.local 수정 금지 (Vercel env와 동기화됨)
